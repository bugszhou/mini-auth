!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("prop-types"),require("promise"),require("events")):"function"==typeof define&&define.amd?define(["exports","prop-types","promise","events"],t):(e=e||self,function(){var r=e["mini-auth"],n=e["mini-auth"]={};t(n,e.PropTypes,e.Promise,e.EventEmitter),n.noConflict=function(){return e["mini-auth"]=r,n}}())}(this,function(e,t,r,n){"use strict";t=t&&t.hasOwnProperty("default")?t.default:t,r=r&&r.hasOwnProperty("default")?r.default:r,n=n&&n.hasOwnProperty("default")?n.default:n;var o=function(){this.__data__=[],this.size=0};var a=function(e,t){return e===t||e!=e&&t!=t};var i=function(e,t){for(var r=e.length;r--;)if(a(e[r][0],t))return r;return-1},u=Array.prototype.splice;var c=function(e){var t=this.__data__,r=i(t,e);return!(r<0||(r==t.length-1?t.pop():u.call(t,r,1),--this.size,0))};var s=function(e){var t=this.__data__,r=i(t,e);return r<0?void 0:t[r][1]};var f=function(e){return i(this.__data__,e)>-1};var l=function(e,t){var r=this.__data__,n=i(r,e);return n<0?(++this.size,r.push([e,t])):r[n][1]=t,this};function p(e){var t=-1,r=null==e?0:e.length;for(this.clear();++t<r;){var n=e[t];this.set(n[0],n[1])}}p.prototype.clear=o,p.prototype.delete=c,p.prototype.get=s,p.prototype.has=f,p.prototype.set=l;var v=p;var h=function(){this.__data__=new v,this.size=0};var d=function(e){var t=this.__data__,r=t.delete(e);return this.size=t.size,r};var y=function(e){return this.__data__.get(e)};var g=function(e){return this.__data__.has(e)},b="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};function w(e,t){return e(t={exports:{}},t.exports),t.exports}var m="object"==typeof b&&b&&b.Object===Object&&b,_="object"==typeof self&&self&&self.Object===Object&&self,j=m||_||Function("return this")(),O=j.Symbol,k=Object.prototype,S=k.hasOwnProperty,P=k.toString,x=O?O.toStringTag:void 0;var C=function(e){var t=S.call(e,x),r=e[x];try{e[x]=void 0;var n=!0}catch(e){}var o=P.call(e);return n&&(t?e[x]=r:delete e[x]),o},T=Object.prototype.toString;var E=function(e){return T.call(e)},M="[object Null]",R="[object Undefined]",A=O?O.toStringTag:void 0;var D=function(e){return null==e?void 0===e?R:M:A&&A in Object(e)?C(e):E(e)};var q=function(e){var t=typeof e;return null!=e&&("object"==t||"function"==t)},z="[object AsyncFunction]",L="[object Function]",N="[object GeneratorFunction]",W="[object Proxy]";var I,F=function(e){if(!q(e))return!1;var t=D(e);return t==L||t==N||t==z||t==W},U=j["__core-js_shared__"],G=(I=/[^.]+$/.exec(U&&U.keys&&U.keys.IE_PROTO||""))?"Symbol(src)_1."+I:"";var $=function(e){return!!G&&G in e},B=Function.prototype.toString;var J=function(e){if(null!=e){try{return B.call(e)}catch(e){}try{return e+""}catch(e){}}return""},Q=/^\[object .+?Constructor\]$/,H=Function.prototype,V=Object.prototype,K=H.toString,X=V.hasOwnProperty,Y=RegExp("^"+K.call(X).replace(/[\\^$.*+?()[\]{}|]/g,"\\$&").replace(/hasOwnProperty|(function).*?(?=\\\()| for .+?(?=\\\])/g,"$1.*?")+"$");var Z=function(e){return!(!q(e)||$(e))&&(F(e)?Y:Q).test(J(e))};var ee=function(e,t){return null==e?void 0:e[t]};var te=function(e,t){var r=ee(e,t);return Z(r)?r:void 0},re=te(j,"Map"),ne=te(Object,"create");var oe=function(){this.__data__=ne?ne(null):{},this.size=0};var ae=function(e){var t=this.has(e)&&delete this.__data__[e];return this.size-=t?1:0,t},ie="__lodash_hash_undefined__",ue=Object.prototype.hasOwnProperty;var ce=function(e){var t=this.__data__;if(ne){var r=t[e];return r===ie?void 0:r}return ue.call(t,e)?t[e]:void 0},se=Object.prototype.hasOwnProperty;var fe=function(e){var t=this.__data__;return ne?void 0!==t[e]:se.call(t,e)},le="__lodash_hash_undefined__";var pe=function(e,t){var r=this.__data__;return this.size+=this.has(e)?0:1,r[e]=ne&&void 0===t?le:t,this};function ve(e){var t=-1,r=null==e?0:e.length;for(this.clear();++t<r;){var n=e[t];this.set(n[0],n[1])}}ve.prototype.clear=oe,ve.prototype.delete=ae,ve.prototype.get=ce,ve.prototype.has=fe,ve.prototype.set=pe;var he=ve;var de=function(){this.size=0,this.__data__={hash:new he,map:new(re||v),string:new he}};var ye=function(e){var t=typeof e;return"string"==t||"number"==t||"symbol"==t||"boolean"==t?"__proto__"!==e:null===e};var ge=function(e,t){var r=e.__data__;return ye(t)?r["string"==typeof t?"string":"hash"]:r.map};var be=function(e){var t=ge(this,e).delete(e);return this.size-=t?1:0,t};var we=function(e){return ge(this,e).get(e)};var me=function(e){return ge(this,e).has(e)};var _e=function(e,t){var r=ge(this,e),n=r.size;return r.set(e,t),this.size+=r.size==n?0:1,this};function je(e){var t=-1,r=null==e?0:e.length;for(this.clear();++t<r;){var n=e[t];this.set(n[0],n[1])}}je.prototype.clear=de,je.prototype.delete=be,je.prototype.get=we,je.prototype.has=me,je.prototype.set=_e;var Oe=je,ke=200;var Se=function(e,t){var r=this.__data__;if(r instanceof v){var n=r.__data__;if(!re||n.length<ke-1)return n.push([e,t]),this.size=++r.size,this;r=this.__data__=new Oe(n)}return r.set(e,t),this.size=r.size,this};function Pe(e){var t=this.__data__=new v(e);this.size=t.size}Pe.prototype.clear=h,Pe.prototype.delete=d,Pe.prototype.get=y,Pe.prototype.has=g,Pe.prototype.set=Se;var xe=Pe,Ce=function(){try{var e=te(Object,"defineProperty");return e({},"",{}),e}catch(e){}}();var Te=function(e,t,r){"__proto__"==t&&Ce?Ce(e,t,{configurable:!0,enumerable:!0,value:r,writable:!0}):e[t]=r};var Ee=function(e,t,r){(void 0===r||a(e[t],r))&&(void 0!==r||t in e)||Te(e,t,r)};var Me=function(e){return function(t,r,n){for(var o=-1,a=Object(t),i=n(t),u=i.length;u--;){var c=i[e?u:++o];if(!1===r(a[c],c,a))break}return t}}(),Re=w(function(e,t){var r=t&&!t.nodeType&&t,n=r&&e&&!e.nodeType&&e,o=n&&n.exports===r?j.Buffer:void 0,a=o?o.allocUnsafe:void 0;e.exports=function(e,t){if(t)return e.slice();var r=e.length,n=a?a(r):new e.constructor(r);return e.copy(n),n}}),Ae=j.Uint8Array;var De=function(e){var t=new e.constructor(e.byteLength);return new Ae(t).set(new Ae(e)),t};var qe=function(e,t){var r=t?De(e.buffer):e.buffer;return new e.constructor(r,e.byteOffset,e.length)};var ze=function(e,t){var r=-1,n=e.length;for(t||(t=Array(n));++r<n;)t[r]=e[r];return t},Le=Object.create,Ne=function(){function e(){}return function(t){if(!q(t))return{};if(Le)return Le(t);e.prototype=t;var r=new e;return e.prototype=void 0,r}}();var We=function(e,t){return function(r){return e(t(r))}}(Object.getPrototypeOf,Object),Ie=Object.prototype;var Fe=function(e){var t=e&&e.constructor;return e===("function"==typeof t&&t.prototype||Ie)};var Ue=function(e){return"function"!=typeof e.constructor||Fe(e)?{}:Ne(We(e))};var Ge=function(e){return null!=e&&"object"==typeof e},$e="[object Arguments]";var Be=function(e){return Ge(e)&&D(e)==$e},Je=Object.prototype,Qe=Je.hasOwnProperty,He=Je.propertyIsEnumerable,Ve=Be(function(){return arguments}())?Be:function(e){return Ge(e)&&Qe.call(e,"callee")&&!He.call(e,"callee")},Ke=Array.isArray,Xe=9007199254740991;var Ye=function(e){return"number"==typeof e&&e>-1&&e%1==0&&e<=Xe};var Ze=function(e){return null!=e&&Ye(e.length)&&!F(e)};var et=function(e){return Ge(e)&&Ze(e)};var rt=function(){return!1},nt=w(function(e,t){var r=t&&!t.nodeType&&t,n=r&&e&&!e.nodeType&&e,o=n&&n.exports===r?j.Buffer:void 0,a=(o?o.isBuffer:void 0)||rt;e.exports=a}),ot="[object Object]",at=Function.prototype,it=Object.prototype,ut=at.toString,ct=it.hasOwnProperty,st=ut.call(Object);var ft=function(e){if(!Ge(e)||D(e)!=ot)return!1;var t=We(e);if(null===t)return!0;var r=ct.call(t,"constructor")&&t.constructor;return"function"==typeof r&&r instanceof r&&ut.call(r)==st},lt={};lt["[object Float32Array]"]=lt["[object Float64Array]"]=lt["[object Int8Array]"]=lt["[object Int16Array]"]=lt["[object Int32Array]"]=lt["[object Uint8Array]"]=lt["[object Uint8ClampedArray]"]=lt["[object Uint16Array]"]=lt["[object Uint32Array]"]=!0,lt["[object Arguments]"]=lt["[object Array]"]=lt["[object ArrayBuffer]"]=lt["[object Boolean]"]=lt["[object DataView]"]=lt["[object Date]"]=lt["[object Error]"]=lt["[object Function]"]=lt["[object Map]"]=lt["[object Number]"]=lt["[object Object]"]=lt["[object RegExp]"]=lt["[object Set]"]=lt["[object String]"]=lt["[object WeakMap]"]=!1;var pt=function(e){return Ge(e)&&Ye(e.length)&&!!lt[D(e)]};var vt=function(e){return function(t){return e(t)}},ht=w(function(e,t){var r=t&&!t.nodeType&&t,n=r&&e&&!e.nodeType&&e,o=n&&n.exports===r&&m.process,a=function(){try{var e=n&&n.require&&n.require("util").types;return e||o&&o.binding&&o.binding("util")}catch(e){}}();e.exports=a}),dt=ht&&ht.isTypedArray,yt=dt?vt(dt):pt;var gt=function(e,t){if(("constructor"!==t||"function"!=typeof e[t])&&"__proto__"!=t)return e[t]},bt=Object.prototype.hasOwnProperty;var wt=function(e,t,r){var n=e[t];bt.call(e,t)&&a(n,r)&&(void 0!==r||t in e)||Te(e,t,r)};var mt=function(e,t,r,n){var o=!r;r||(r={});for(var a=-1,i=t.length;++a<i;){var u=t[a],c=n?n(r[u],e[u],u,r,e):void 0;void 0===c&&(c=e[u]),o?Te(r,u,c):wt(r,u,c)}return r};var _t=function(e,t){for(var r=-1,n=Array(e);++r<e;)n[r]=t(r);return n},jt=9007199254740991,Ot=/^(?:0|[1-9]\d*)$/;var kt=function(e,t){var r=typeof e;return!!(t=null==t?jt:t)&&("number"==r||"symbol"!=r&&Ot.test(e))&&e>-1&&e%1==0&&e<t},St=Object.prototype.hasOwnProperty;var Pt=function(e,t){var r=Ke(e),n=!r&&Ve(e),o=!r&&!n&&nt(e),a=!r&&!n&&!o&&yt(e),i=r||n||o||a,u=i?_t(e.length,String):[],c=u.length;for(var s in e)!t&&!St.call(e,s)||i&&("length"==s||o&&("offset"==s||"parent"==s)||a&&("buffer"==s||"byteLength"==s||"byteOffset"==s)||kt(s,c))||u.push(s);return u};var xt=function(e){var t=[];if(null!=e)for(var r in Object(e))t.push(r);return t},Ct=Object.prototype.hasOwnProperty;var Tt=function(e){if(!q(e))return xt(e);var t=Fe(e),r=[];for(var n in e)("constructor"!=n||!t&&Ct.call(e,n))&&r.push(n);return r};var Et=function(e){return Ze(e)?Pt(e,!0):Tt(e)};var Mt=function(e){return mt(e,Et(e))};var Rt=function(e,t,r,n,o,a,i){var u=gt(e,r),c=gt(t,r),s=i.get(c);if(s)Ee(e,r,s);else{var f=a?a(u,c,r+"",e,t,i):void 0,l=void 0===f;if(l){var p=Ke(c),v=!p&&nt(c),h=!p&&!v&&yt(c);f=c,p||v||h?Ke(u)?f=u:et(u)?f=ze(u):v?(l=!1,f=Re(c,!0)):h?(l=!1,f=qe(c,!0)):f=[]:ft(c)||Ve(c)?(f=u,Ve(u)?f=Mt(u):q(u)&&!F(u)||(f=Ue(c))):l=!1}l&&(i.set(c,f),o(f,c,n,a,i),i.delete(c)),Ee(e,r,f)}};var At=function e(t,r,n,o,a){t!==r&&Me(r,function(i,u){if(a||(a=new xe),q(i))Rt(t,r,u,n,e,o,a);else{var c=o?o(gt(t,u),i,u+"",t,r,a):void 0;void 0===c&&(c=i),Ee(t,u,c)}},Et)};var Dt=function(e){return e};var qt=function(e,t,r){switch(r.length){case 0:return e.call(t);case 1:return e.call(t,r[0]);case 2:return e.call(t,r[0],r[1]);case 3:return e.call(t,r[0],r[1],r[2])}return e.apply(t,r)},zt=Math.max;var Lt=function(e,t,r){return t=zt(void 0===t?e.length-1:t,0),function(){for(var n=arguments,o=-1,a=zt(n.length-t,0),i=Array(a);++o<a;)i[o]=n[t+o];o=-1;for(var u=Array(t+1);++o<t;)u[o]=n[o];return u[t]=r(i),qt(e,this,u)}};var Nt=function(e){return function(){return e}},Wt=Ce?function(e,t){return Ce(e,"toString",{configurable:!0,enumerable:!1,value:Nt(t),writable:!0})}:Dt,It=800,Ft=16,Ut=Date.now;var Gt=function(e){var t=0,r=0;return function(){var n=Ut(),o=Ft-(n-r);if(r=n,o>0){if(++t>=It)return arguments[0]}else t=0;return e.apply(void 0,arguments)}}(Wt);var $t=function(e,t){return Gt(Lt(e,t,Dt),e+"")};var Bt=function(e,t,r){if(!q(r))return!1;var n=typeof t;return!!("number"==n?Ze(r)&&kt(t,r.length):"string"==n&&t in r)&&a(r[t],e)};var Jt=function(e){return $t(function(t,r){var n=-1,o=r.length,a=o>1?r[o-1]:void 0,i=o>2?r[2]:void 0;for(a=e.length>3&&"function"==typeof a?(o--,a):void 0,i&&Bt(r[0],r[1],i)&&(a=o<3?void 0:a,o=1),t=Object(t);++n<o;){var u=r[n];u&&e(t,u,n,a)}return t})}(function(e,t,r){At(e,t,r)}),Qt=["weapp","aliapp","swan","ttapp"],Ht=["OPTIONS","options","GET","get","HEAD","head","POST","post","PUT","put","DELETE","delete","TRACE","trace","CONNECT","connect"];var Vt=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")};function Kt(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}var Xt=function(e,t,r){return t&&Kt(e.prototype,t),r&&Kt(e,r),e},Yt=w(function(e){function t(e){return(t="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function r(n){return"function"==typeof Symbol&&"symbol"===t(Symbol.iterator)?e.exports=r=function(e){return t(e)}:e.exports=r=function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":t(e)},r(n)}e.exports=r});var Zt=function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e};var er=function(e,t){return!t||"object"!==Yt(t)&&"function"!=typeof t?Zt(e):t},tr=w(function(e){function t(r){return e.exports=t=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},t(r)}e.exports=t}),rr=w(function(e){function t(r,n){return e.exports=t=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},t(r,n)}e.exports=t});var nr=function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&rr(e,t)};var or=function(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e};var ar=function(e,t){var r=t.get(e);if(!r)throw new TypeError("attempted to get private field on non-instance");return r.get?r.get.call(e):r.value};var ir=function(e,t,r){var n=t.get(e);if(!n)throw new TypeError("attempted to set private field on non-instance");if(n.set)n.set.call(e,r);else{if(!n.writable)throw new TypeError("attempted to set read only private field");n.value=r}return r},ur=function(e){function t(){var e;return Vt(this,t),e=er(this,tr(t).call(this)),cr.set(Zt(e),{writable:!0,value:{}}),sr.set(Zt(e),{writable:!0,value:[]}),fr.set(Zt(e),{writable:!0,value:[]}),lr.set(Zt(e),{writable:!0,value:[]}),e}return nr(t,n),Xt(t,[{key:"config",value:function(){}},{key:"queue",value:function(){}},{key:"use",value:function(){}},{key:"getToken",value:function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{isRefresh:!1,withCredentials:!0};e.isRefresh,e.withCredentials}},{key:"getUserInfo",value:function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};e.rawData,e.signature,e.encryptedData,e.iv}},{key:"addEventListener",value:function(){}}]),t}(),cr=new WeakMap,sr=new WeakMap,fr=new WeakMap,lr=new WeakMap,pr="MINI_AUTH:token:",vr="".concat(pr,"beforeRefresh"),hr="".concat(pr,"afterRefresh"),dr="".concat(pr,"beforeCache"),yr="".concat(pr,"afterCache"),gr="".concat(pr,"expired"),br="".concat(pr,"beforeLogin"),wr="".concat(pr,"afterLogin"),mr="".concat(pr,"beforeRequest"),_r="".concat(pr,"afterRequest"),jr="".concat(pr,"wx:beforeLogin"),Or="".concat(pr,"wx:successLogin"),kr="".concat(pr,"wx:failLogin"),Sr="".concat(pr,"wx:beforeRequest"),Pr="".concat(pr,"wx:successRequest"),xr="".concat(pr,"wx:failRequest"),Cr="".concat(pr,"ali:beforeLogin"),Tr="".concat(pr,"ali:successLogin"),Er="".concat(pr,"ali:failLogin"),Mr="".concat(pr,"ali:beforeRequest"),Rr="".concat(pr,"ali:successRequest"),Ar="".concat(pr,"ali:failRequest");function Dr(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{},t=e.errCode||0;return{errCode:e.errCode||0,errMsg:0===t?"":e.errMsg||JSON.stringify(e),status:e.statusCode||e.status||-1,headers:e.header||null,data:e.data||null}}var qr=function(){function e(){Vt(this,e),or(this,"context",{}),or(this,"middleware",[])}return Xt(e,[{key:"createContext",value:function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{},t=Object.create(this.context);return Object.assign(t,e)}},{key:"dispatch",value:function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{},t=1<arguments.length?arguments[1]:void 0,r=this.createContext(e),n=this.runMiddleware(t||this.middleware);return n(r)}},{key:"runMiddleware",value:function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:[];return function(t,n){var o=-1;return new r(function(r,a){!function i(u,c){if(u<=o)return a(Dr({errCode:5004,errMsg:"next() called multiple times"}));if(c)return a(c);var s=e[o=u];if(o===e.length&&(s=n),!s)return r(t);try{return s(t,i.bind(null,o+1))}catch(e){return a(Dr({errCode:5005,errMsg:JSON.stringify(e)}))}}(0,null)})}}},{key:"use",value:function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:function(){};if("function"!=typeof e)throw new Error("middle must be function!");this.middleware.push(e)}},{key:"useBatch",value:function(){var e=this,t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:[];t.forEach(function(t){e.use(t)})}}]),e}();var zr={timeout:2e4,scopes:["auth_base"],force:!0};function Lr(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:"noName",r=2<arguments.length&&void 0!==arguments[2]?arguments[2]:{};e&&"function"==typeof e.emit&&e.emit(t,r)}function Nr(){return"undefined"!=typeof wx&&wx?wx:"undefined"!=typeof my&&my?my:"undefined"!=typeof swan&&swan?swan:"undefined"!=typeof tt&&tt?tt:global}var Wr=Nr();function Ir(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{env:"weapp"},n=e.timeout,o=e.env,a=e.scopes,i=e.force,u=e.self,c=null;switch(function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};t.checkPropTypes({timeout:t.number,scopes:t.array,force:t.bool},e)}(Jt(zr,{timeout:n,scopes:a,force:i})),o){case"aliapp":c=function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{scopes:["auth_base"]},t=e.scopes,n=e.self;return new r(function(e,r){Wr.getAuthCode({scopes:t,success:function(t){e({errCode:0,errMsg:"",jsCode:t.authCode}),Lr(n,Tr,{res:t})},fail:function(e){r({errCode:5009,errMsg:e.errMsg||JSON.stringify(e),jsCode:""}),Lr(n,Er,{err:e})}}),Lr(n,Cr,{scopes:t})})}({scopes:a,self:u});break;case"swan":case"ttapp":case"weapp":default:c=function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{timeout:2e4},t=e.timeout,n=e.self;return new r(function(e,r){wx.login({timeout:t,success:function(t){e({errCode:0,errMsg:"",jsCode:t.code}),Lr(n,Or,{res:t})},fail:function(e){r({errCode:5e3,errMsg:e.errMsg||JSON.stringify(e),jsCode:""}),Lr(n,kr,{err:e})}}),Lr(n,jr,{timeout:t})})}({timeout:n,self:u})}return c}var Fr={url:"",data:{},headers:{},timeout:3e4,method:"GET"};function Ur(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),r.push.apply(r,n)}return r}function Gr(e){for(var t,r=1;r<arguments.length;r++)t=null==arguments[r]?{}:arguments[r],r%2?Ur(t,!0).forEach(function(r){or(e,r,t[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):Ur(t).forEach(function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(t,r))});return e}function $r(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),r.push.apply(r,n)}return r}function Br(e){for(var t,r=1;r<arguments.length;r++)t=null==arguments[r]?{}:arguments[r],r%2?$r(t,!0).forEach(function(r){or(e,r,t[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):$r(t).forEach(function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(t,r))});return e}var Jr=Nr();function Qr(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{env:"weapp"},n=e.url,o=e.timeout,a=e.data,i=e.headers,u=e.method,c=e.env,s=e.self,f=null;switch(function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};t.checkPropTypes({url:t.string,data:t.object,headers:t.object,timeout:t.number,method:t.string},e)}(Jt(Fr,{url:n,timeout:o,data:a,headers:i,method:u})),c){case"aliapp":f=function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{method:"GET",data:{}},t=e.url,n=e.data,o=e.headers,a=e.method,i=e.timeout,u=e.self;return new r(function(e,r){Jr.request({url:t,data:n,headers:o,method:a,timeout:i,success:function(t){e(Dr(Br({errCode:0},t))),Lr(u,Rr,{res:t})},fail:function(e){var t=5006;t=e.errMsg?-1<e.errMsg.toLowerCase().indexOf("timeout")?5007:5008:5006,r(Dr(Br({errCode:t},e))),Lr(u,Ar,{err:e})}}),Lr(u,Mr,{url:t,data:n,headers:o,method:a,timeout:i})})}({self:s,url:n,data:a,headers:i,method:u});break;case"swan":case"ttapp":case"weapp":default:f=function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{method:"GET",data:{}},t=e.url,n=e.data,o=e.headers,a=e.method,i=e.self;return new r(function(e,r){wx.request({url:t,data:n,header:o,method:a,success:function(t){e(Dr(Gr({errCode:0},t))),Lr(i,Pr,{res:t})},fail:function(e){var t=5003;t=e.errMsg?-1<e.errMsg.toLowerCase().indexOf("timeout")?5001:5002:5003,r(Dr(Gr({errCode:t},e))),Lr(i,xr,{err:e})}}),Lr(i,Sr,{url:t,data:n,headers:o,method:a})})}({self:s,url:n,data:a,headers:i,method:u})}return f}var Hr=Nr(),Vr={setStorageSync:Hr.setStorageSync.bind(Hr),getStorageSync:Hr.getStorageSync.bind(Hr),removeStorageSync:Hr.removeStorageSync.bind(Hr)},Kr=Nr(),Xr={setStorageSync:Kr.setStorageSync.bind(Kr),getStorageSync:Kr.getStorageSync.bind(Kr),removeStorageSync:Kr.removeStorageSync.bind(Kr)};function Yr(){var e=(0<arguments.length&&void 0!==arguments[0]?arguments[0]:{env:"weapp"}).env;return function(){var t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:"",r=1<arguments.length&&void 0!==arguments[1]?arguments[1]:"";try{switch(e){case"aliapp":Xr.setStorageSync({key:t,data:r});break;case"swan":case"ttapp":case"weapp":default:Vr.setStorageSync(t,r)}}catch(e){throw e}}}function Zr(){var e=(0<arguments.length&&void 0!==arguments[0]?arguments[0]:{env:"weapp"}).env;return function(){var t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:"",r=null;try{switch(e){case"aliapp":r=Xr.getStorageSync({key:t}).data;break;case"swan":case"ttapp":case"weapp":default:r=Vr.getStorageSync(t)}}catch(e){throw e}return r}}function en(){var e=(0<arguments.length&&void 0!==arguments[0]?arguments[0]:{env:"weapp"}).env;return function(){var t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:"";try{switch(e){case"aliapp":Xr.removeStorageSync({key:t});break;case"swan":case"ttapp":case"weapp":default:Vr.removeStorageSync(t)}}catch(e){throw e}}}function tn(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),r.push.apply(r,n)}return r}function rn(e){for(var t,r=1;r<arguments.length;r++)t=null==arguments[r]?{}:arguments[r],r%2?tn(t,!0).forEach(function(r){or(e,r,t[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):tn(t).forEach(function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(t,r))});return e}function nn(e,t,r){if(!t.has(e))throw new TypeError("attempted to get private field on non-instance");return r}var on=function(e){function t(){var e,r=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};return Vt(this,t),e=er(this,tr(t).call(this)),hn.add(Zt(e)),vn.add(Zt(e)),an.set(Zt(e),{writable:!0,value:{}}),un.set(Zt(e),{writable:!0,value:[]}),cn.set(Zt(e),{writable:!0,value:[]}),sn.set(Zt(e),{writable:!0,value:[]}),fn.set(Zt(e),{writable:!0,value:[]}),ln.set(Zt(e),{writable:!0,value:68e5}),pn.set(Zt(e),{writable:!0,value:!1}),or(Zt(e),"tokenReqData",{}),or(Zt(e),"tokenResData",{}),e.middleware=new qr,ir(Zt(e),an,r),e}return nr(t,ur),Xt(t,[{key:"use",value:function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:"",t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:function(){};if("function"==typeof t)switch(e){case"afterToken":ar(this,sn).push(t);break;case"user":ar(this,fn).push(t);break;case"token":default:ar(this,cn).push(t)}}},{key:"set2Storage",value:function(){function e(t){try{Yr({env:ar(this,an).env})(n.key,n.data)}catch(r){console.error(r),0<t&&e.call(this,t-1)}return n.data}var t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:"token",r=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{},n=nn(this,hn,yn).call(this,t,r);return e.call(this,3)}},{key:"getDataFromStorage",value:function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:"token",t=null;try{t=Zr({env:ar(this,an).env})(nn(this,vn,dn).call(this,e))}catch(e){console.error(e)}return t}},{key:"clearStorage",value:function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:"token";try{en({env:ar(this,an).env})(nn(this,vn,dn).call(this,e))}catch(e){console.error(e)}}},{key:"isExpired",value:function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};if(e){var t=e.expirationTime;return!(t&&t>Date.now())}return!0}},{key:"setTokenExpires",value:function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:0;(!e||isNaN(e))&&(e=68e5),ir(this,ln,+e)}},{key:"runQueues",value:function(e,t){if(ar(this,un)&&Array.isArray(ar(this,un))){var r=ar(this,un).length;ar(this,un).splice(0,r).forEach(function(r){var n=r.resolve,o=r.reject;return e?o(e):n(t)})}}},{key:"getToken",value:function(){var e=this,t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{isRefresh:!1},n=t.isRefresh,o=t.scopes;return new r(function(t,r){if(ar(e,pn))return ar(e,un).push({resolve:t,reject:r});var a=ar(e,an).env,i=ar(e,an).tokenReqConfig,u=i.url,c=i.headers,s=i.method,f=null;if(n)e.emit(vr),e.clearStorage("token"),e.emit(hr);else{if((f=e.getDataFromStorage("token"))&&!e.isExpired(f))return e.emit(dr,f),setTimeout(function(){t(f),e.emit(yr,f)});e.emit(gr),e.clearStorage("token")}e.emit(br),ir(e,pn,!0),Ir({self:e,env:a,scopes:o}).then(function(t){return e.tokenReqData.jsCode=t.jsCode,e.emit(wr,t),e.middleware.dispatch(e,ar(e,cn))}).then(function(t){return e.emit(mr),Qr({self:e,env:a,url:u,method:s,headers:c||ar(e,an).headers,data:rn({},t.tokenReqData)})}).then(function(t){return e.tokenResData=t,e.middleware.dispatch(e,ar(e,sn))}).then(function(t){return e.emit(_r,t.tokenResData),e.set2Storage("token",t.tokenResData)}).then(function(r){t(r),e.runQueues(null,r),ir(e,pn,!1),ir(e,un,[])}).catch(function(t){r(t),e.runQueues(t),ir(e,pn,!1),ir(e,un,[])})})}},{key:"config",get:function(){return ar(this,an)}},{key:"queue",get:function(){return this.waitQueues}}]),t}(),an=new WeakMap,un=new WeakMap,cn=new WeakMap,sn=new WeakMap,fn=new WeakMap,ln=new WeakMap,pn=new WeakMap,vn=new WeakSet,hn=new WeakSet,dn=function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:"token";return"MINI_AUTH:".concat(e,":").concat(ar(this,an).appid)},yn=function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:"token",t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{};return{key:nn(this,vn,dn).call(this,e),data:{data:t,expires:ar(this,ln),expirationTime:Date.now()+ar(this,ln)}}},gn={withCredentials:!1,env:"weapp",appid:"mockAppid",tokenReqConfig:{url:"",method:"GET",headers:{"content-type":"application/json"},timeout:1e4},userInfoReqConfig:{url:"",method:"GET",headers:{"content-type":"application/json"},timeout:1e4}};function bn(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{},r=Jt(gn,e);return function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};t.checkPropTypes({withCredentials:t.bool.isRequired,env:t.oneOf(Qt),appid:t.string,tokenReqConfig:t.shape({url:t.string,method:t.oneOf(Ht).isRequired,headers:t.object,timeout:t.number}),userInfoReqConfig:t.shape({url:t.string,method:t.oneOf(Ht).isRequired,headers:t.object,timeout:t.number})},e)}(r),new on(r)}var wn=bn(gn);wn.create=bn,e.default=on,e.miniAuth=wn,Object.defineProperty(e,"__esModule",{value:!0})});
//# sourceMappingURL=mini-auth.common.js.map
