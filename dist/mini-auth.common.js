!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("prop-types"),require("promise"),require("events")):"function"==typeof define&&define.amd?define(["exports","prop-types","promise","events"],t):(e=e||self,function(){var r=e["mini-auth"],n=e["mini-auth"]={};t(n,e.PropTypes,e.Promise,e.EventEmitter),n.noConflict=function(){return e["mini-auth"]=r,n}}())}(this,(function(e,t,r,n){"use strict";t=t&&t.hasOwnProperty("default")?t.default:t,r=r&&r.hasOwnProperty("default")?r.default:r,n=n&&n.hasOwnProperty("default")?n.default:n;var o=function(){this.__data__=[],this.size=0};var a=function(e,t){return e===t||e!=e&&t!=t};var i=function(e,t){for(var r=e.length;r--;)if(a(e[r][0],t))return r;return-1},u=Array.prototype.splice;var c=function(e){var t=this.__data__,r=i(t,e);return!(r<0)&&(r==t.length-1?t.pop():u.call(t,r,1),--this.size,!0)};var s=function(e){var t=this.__data__,r=i(t,e);return r<0?void 0:t[r][1]};var f=function(e){return i(this.__data__,e)>-1};var l=function(e,t){var r=this.__data__,n=i(r,e);return n<0?(++this.size,r.push([e,t])):r[n][1]=t,this};function p(e){var t=-1,r=null==e?0:e.length;for(this.clear();++t<r;){var n=e[t];this.set(n[0],n[1])}}p.prototype.clear=o,p.prototype.delete=c,p.prototype.get=s,p.prototype.has=f,p.prototype.set=l;var v=p;var h=function(){this.__data__=new v,this.size=0};var d=function(e){var t=this.__data__,r=t.delete(e);return this.size=t.size,r};var y=function(e){return this.__data__.get(e)};var g=function(e){return this.__data__.has(e)},b="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};function w(e,t){return e(t={exports:{}},t.exports),t.exports}var m="object"==typeof b&&b&&b.Object===Object&&b,_="object"==typeof self&&self&&self.Object===Object&&self,O=m||_||Function("return this")(),j=O.Symbol,k=Object.prototype,S=k.hasOwnProperty,P=k.toString,x=j?j.toStringTag:void 0;var T=function(e){var t=S.call(e,x),r=e[x];try{e[x]=void 0;var n=!0}catch(e){}var o=P.call(e);return n&&(t?e[x]=r:delete e[x]),o},E=Object.prototype.toString;var C=function(e){return E.call(e)},R=j?j.toStringTag:void 0;var A=function(e){return null==e?void 0===e?"[object Undefined]":"[object Null]":R&&R in Object(e)?T(e):C(e)};var M=function(e){var t=typeof e;return null!=e&&("object"==t||"function"==t)};var q,D=function(e){if(!M(e))return!1;var t=A(e);return"[object Function]"==t||"[object GeneratorFunction]"==t||"[object AsyncFunction]"==t||"[object Proxy]"==t},z=O["__core-js_shared__"],N=(q=/[^.]+$/.exec(z&&z.keys&&z.keys.IE_PROTO||""))?"Symbol(src)_1."+q:"";var L=function(e){return!!N&&N in e},W=Function.prototype.toString;var I=function(e){if(null!=e){try{return W.call(e)}catch(e){}try{return e+""}catch(e){}}return""},F=/^\[object .+?Constructor\]$/,U=Function.prototype,G=Object.prototype,$=U.toString,B=G.hasOwnProperty,J=RegExp("^"+$.call(B).replace(/[\\^$.*+?()[\]{}|]/g,"\\$&").replace(/hasOwnProperty|(function).*?(?=\\\()| for .+?(?=\\\])/g,"$1.*?")+"$");var Q=function(e){return!(!M(e)||L(e))&&(D(e)?J:F).test(I(e))};var H=function(e,t){return null==e?void 0:e[t]};var K=function(e,t){var r=H(e,t);return Q(r)?r:void 0},V=K(O,"Map"),X=K(Object,"create");var Y=function(){this.__data__=X?X(null):{},this.size=0};var Z=function(e){var t=this.has(e)&&delete this.__data__[e];return this.size-=t?1:0,t},ee=Object.prototype.hasOwnProperty;var te=function(e){var t=this.__data__;if(X){var r=t[e];return"__lodash_hash_undefined__"===r?void 0:r}return ee.call(t,e)?t[e]:void 0},re=Object.prototype.hasOwnProperty;var ne=function(e){var t=this.__data__;return X?void 0!==t[e]:re.call(t,e)};var oe=function(e,t){var r=this.__data__;return this.size+=this.has(e)?0:1,r[e]=X&&void 0===t?"__lodash_hash_undefined__":t,this};function ae(e){var t=-1,r=null==e?0:e.length;for(this.clear();++t<r;){var n=e[t];this.set(n[0],n[1])}}ae.prototype.clear=Y,ae.prototype.delete=Z,ae.prototype.get=te,ae.prototype.has=ne,ae.prototype.set=oe;var ie=ae;var ue=function(){this.size=0,this.__data__={hash:new ie,map:new(V||v),string:new ie}};var ce=function(e){var t=typeof e;return"string"==t||"number"==t||"symbol"==t||"boolean"==t?"__proto__"!==e:null===e};var se=function(e,t){var r=e.__data__;return ce(t)?r["string"==typeof t?"string":"hash"]:r.map};var fe=function(e){var t=se(this,e).delete(e);return this.size-=t?1:0,t};var le=function(e){return se(this,e).get(e)};var pe=function(e){return se(this,e).has(e)};var ve=function(e,t){var r=se(this,e),n=r.size;return r.set(e,t),this.size+=r.size==n?0:1,this};function he(e){var t=-1,r=null==e?0:e.length;for(this.clear();++t<r;){var n=e[t];this.set(n[0],n[1])}}he.prototype.clear=ue,he.prototype.delete=fe,he.prototype.get=le,he.prototype.has=pe,he.prototype.set=ve;var de=he;var ye=function(e,t){var r=this.__data__;if(r instanceof v){var n=r.__data__;if(!V||n.length<199)return n.push([e,t]),this.size=++r.size,this;r=this.__data__=new de(n)}return r.set(e,t),this.size=r.size,this};function ge(e){var t=this.__data__=new v(e);this.size=t.size}ge.prototype.clear=h,ge.prototype.delete=d,ge.prototype.get=y,ge.prototype.has=g,ge.prototype.set=ye;var be=ge,we=function(){try{var e=K(Object,"defineProperty");return e({},"",{}),e}catch(e){}}();var me=function(e,t,r){"__proto__"==t&&we?we(e,t,{configurable:!0,enumerable:!0,value:r,writable:!0}):e[t]=r};var _e=function(e,t,r){(void 0!==r&&!a(e[t],r)||void 0===r&&!(t in e))&&me(e,t,r)};var Oe=function(e){return function(t,r,n){for(var o=-1,a=Object(t),i=n(t),u=i.length;u--;){var c=i[e?u:++o];if(!1===r(a[c],c,a))break}return t}}(),je=w((function(e,t){var r=t&&!t.nodeType&&t,n=r&&e&&!e.nodeType&&e,o=n&&n.exports===r?O.Buffer:void 0,a=o?o.allocUnsafe:void 0;e.exports=function(e,t){if(t)return e.slice();var r=e.length,n=a?a(r):new e.constructor(r);return e.copy(n),n}})),ke=O.Uint8Array;var Se=function(e){var t=new e.constructor(e.byteLength);return new ke(t).set(new ke(e)),t};var Pe=function(e,t){var r=t?Se(e.buffer):e.buffer;return new e.constructor(r,e.byteOffset,e.length)};var xe=function(e,t){var r=-1,n=e.length;for(t||(t=Array(n));++r<n;)t[r]=e[r];return t},Te=Object.create,Ee=function(){function e(){}return function(t){if(!M(t))return{};if(Te)return Te(t);e.prototype=t;var r=new e;return e.prototype=void 0,r}}();var Ce=function(e,t){return function(r){return e(t(r))}}(Object.getPrototypeOf,Object),Re=Object.prototype;var Ae=function(e){var t=e&&e.constructor;return e===("function"==typeof t&&t.prototype||Re)};var Me=function(e){return"function"!=typeof e.constructor||Ae(e)?{}:Ee(Ce(e))};var qe=function(e){return null!=e&&"object"==typeof e};var De=function(e){return qe(e)&&"[object Arguments]"==A(e)},ze=Object.prototype,Ne=ze.hasOwnProperty,Le=ze.propertyIsEnumerable,We=De(function(){return arguments}())?De:function(e){return qe(e)&&Ne.call(e,"callee")&&!Le.call(e,"callee")},Ie=Array.isArray;var Fe=function(e){return"number"==typeof e&&e>-1&&e%1==0&&e<=9007199254740991};var Ue=function(e){return null!=e&&Fe(e.length)&&!D(e)};var Ge=function(e){return qe(e)&&Ue(e)};var $e=function(){return!1},Be=w((function(e,t){var r=t&&!t.nodeType&&t,n=r&&e&&!e.nodeType&&e,o=n&&n.exports===r?O.Buffer:void 0,a=(o?o.isBuffer:void 0)||$e;e.exports=a})),Je=Function.prototype,Qe=Object.prototype,He=Je.toString,Ke=Qe.hasOwnProperty,Ve=He.call(Object);var Xe=function(e){if(!qe(e)||"[object Object]"!=A(e))return!1;var t=Ce(e);if(null===t)return!0;var r=Ke.call(t,"constructor")&&t.constructor;return"function"==typeof r&&r instanceof r&&He.call(r)==Ve},Ye={};Ye["[object Float32Array]"]=Ye["[object Float64Array]"]=Ye["[object Int8Array]"]=Ye["[object Int16Array]"]=Ye["[object Int32Array]"]=Ye["[object Uint8Array]"]=Ye["[object Uint8ClampedArray]"]=Ye["[object Uint16Array]"]=Ye["[object Uint32Array]"]=!0,Ye["[object Arguments]"]=Ye["[object Array]"]=Ye["[object ArrayBuffer]"]=Ye["[object Boolean]"]=Ye["[object DataView]"]=Ye["[object Date]"]=Ye["[object Error]"]=Ye["[object Function]"]=Ye["[object Map]"]=Ye["[object Number]"]=Ye["[object Object]"]=Ye["[object RegExp]"]=Ye["[object Set]"]=Ye["[object String]"]=Ye["[object WeakMap]"]=!1;var Ze=function(e){return qe(e)&&Fe(e.length)&&!!Ye[A(e)]};var et=function(e){return function(t){return e(t)}},rt=w((function(e,t){var r=t&&!t.nodeType&&t,n=r&&e&&!e.nodeType&&e,o=n&&n.exports===r&&m.process,a=function(){try{var e=n&&n.require&&n.require("util").types;return e||o&&o.binding&&o.binding("util")}catch(e){}}();e.exports=a})),nt=rt&&rt.isTypedArray,ot=nt?et(nt):Ze;var at=function(e,t){if(("constructor"!==t||"function"!=typeof e[t])&&"__proto__"!=t)return e[t]},it=Object.prototype.hasOwnProperty;var ut=function(e,t,r){var n=e[t];it.call(e,t)&&a(n,r)&&(void 0!==r||t in e)||me(e,t,r)};var ct=function(e,t,r,n){var o=!r;r||(r={});for(var a=-1,i=t.length;++a<i;){var u=t[a],c=n?n(r[u],e[u],u,r,e):void 0;void 0===c&&(c=e[u]),o?me(r,u,c):ut(r,u,c)}return r};var st=function(e,t){for(var r=-1,n=Array(e);++r<e;)n[r]=t(r);return n},ft=/^(?:0|[1-9]\d*)$/;var lt=function(e,t){var r=typeof e;return!!(t=null==t?9007199254740991:t)&&("number"==r||"symbol"!=r&&ft.test(e))&&e>-1&&e%1==0&&e<t},pt=Object.prototype.hasOwnProperty;var vt=function(e,t){var r=Ie(e),n=!r&&We(e),o=!r&&!n&&Be(e),a=!r&&!n&&!o&&ot(e),i=r||n||o||a,u=i?st(e.length,String):[],c=u.length;for(var s in e)!t&&!pt.call(e,s)||i&&("length"==s||o&&("offset"==s||"parent"==s)||a&&("buffer"==s||"byteLength"==s||"byteOffset"==s)||lt(s,c))||u.push(s);return u};var ht=function(e){var t=[];if(null!=e)for(var r in Object(e))t.push(r);return t},dt=Object.prototype.hasOwnProperty;var yt=function(e){if(!M(e))return ht(e);var t=Ae(e),r=[];for(var n in e)("constructor"!=n||!t&&dt.call(e,n))&&r.push(n);return r};var gt=function(e){return Ue(e)?vt(e,!0):yt(e)};var bt=function(e){return ct(e,gt(e))};var wt=function(e,t,r,n,o,a,i){var u=at(e,r),c=at(t,r),s=i.get(c);if(s)_e(e,r,s);else{var f=a?a(u,c,r+"",e,t,i):void 0,l=void 0===f;if(l){var p=Ie(c),v=!p&&Be(c),h=!p&&!v&&ot(c);f=c,p||v||h?Ie(u)?f=u:Ge(u)?f=xe(u):v?(l=!1,f=je(c,!0)):h?(l=!1,f=Pe(c,!0)):f=[]:Xe(c)||We(c)?(f=u,We(u)?f=bt(u):M(u)&&!D(u)||(f=Me(c))):l=!1}l&&(i.set(c,f),o(f,c,n,a,i),i.delete(c)),_e(e,r,f)}};var mt=function e(t,r,n,o,a){t!==r&&Oe(r,(function(i,u){if(a||(a=new be),M(i))wt(t,r,u,n,e,o,a);else{var c=o?o(at(t,u),i,u+"",t,r,a):void 0;void 0===c&&(c=i),_e(t,u,c)}}),gt)};var _t=function(e){return e};var Ot=function(e,t,r){switch(r.length){case 0:return e.call(t);case 1:return e.call(t,r[0]);case 2:return e.call(t,r[0],r[1]);case 3:return e.call(t,r[0],r[1],r[2])}return e.apply(t,r)},jt=Math.max;var kt=function(e,t,r){return t=jt(void 0===t?e.length-1:t,0),function(){for(var n=arguments,o=-1,a=jt(n.length-t,0),i=Array(a);++o<a;)i[o]=n[t+o];o=-1;for(var u=Array(t+1);++o<t;)u[o]=n[o];return u[t]=r(i),Ot(e,this,u)}};var St=function(e){return function(){return e}},Pt=we?function(e,t){return we(e,"toString",{configurable:!0,enumerable:!1,value:St(t),writable:!0})}:_t,xt=Date.now;var Tt=function(e){var t=0,r=0;return function(){var n=xt(),o=16-(n-r);if(r=n,o>0){if(++t>=800)return arguments[0]}else t=0;return e.apply(void 0,arguments)}}(Pt);var Et=function(e,t){return Tt(kt(e,t,_t),e+"")};var Ct=function(e,t,r){if(!M(r))return!1;var n=typeof t;return!!("number"==n?Ue(r)&&lt(t,r.length):"string"==n&&t in r)&&a(r[t],e)};var Rt=function(e){return Et((function(t,r){var n=-1,o=r.length,a=o>1?r[o-1]:void 0,i=o>2?r[2]:void 0;for(a=e.length>3&&"function"==typeof a?(o--,a):void 0,i&&Ct(r[0],r[1],i)&&(a=o<3?void 0:a,o=1),t=Object(t);++n<o;){var u=r[n];u&&e(t,u,n,a)}return t}))}((function(e,t,r){mt(e,t,r)})),At=["weapp","aliapp","swan","ttapp"],Mt=["OPTIONS","options","GET","get","HEAD","head","POST","post","PUT","put","DELETE","delete","TRACE","trace","CONNECT","connect"];function qt(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};return t.checkPropTypes({withCredentials:t.bool.isRequired,env:t.oneOf(At),appid:t.string,tokenReqConfig:t.shape({url:t.string,method:t.oneOf(Mt).isRequired,headers:t.object,timeout:t.number}),userInfoReqConfig:t.shape({url:t.string,method:t.oneOf(Mt).isRequired,headers:t.object,timeout:t.number})},e)}var Dt=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")};function zt(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}var Nt=function(e,t,r){return t&&zt(e.prototype,t),r&&zt(e,r),e},Lt=w((function(e){function t(e){return(t="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function r(n){return"function"==typeof Symbol&&"symbol"===t(Symbol.iterator)?e.exports=r=function(e){return t(e)}:e.exports=r=function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":t(e)},r(n)}e.exports=r}));var Wt=function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e};var It=function(e,t){return!t||"object"!==Lt(t)&&"function"!=typeof t?Wt(e):t},Ft=w((function(e){function t(r){return e.exports=t=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},t(r)}e.exports=t})),Ut=w((function(e){function t(r,n){return e.exports=t=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},t(r,n)}e.exports=t}));var Gt=function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&Ut(e,t)};var $t=function(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e};var Bt=function(e,t){var r=t.get(e);if(!r)throw new TypeError("attempted to get private field on non-instance");return r.get?r.get.call(e):r.value};var Jt=function(e,t,r){var n=t.get(e);if(!n)throw new TypeError("attempted to set private field on non-instance");if(n.set)n.set.call(e,r);else{if(!n.writable)throw new TypeError("attempted to set read only private field");n.value=r}return r},Qt=function(e){function t(){var e;return Dt(this,t),e=It(this,Ft(t).call(this)),Ht.set(Wt(e),{writable:!0,value:{}}),Kt.set(Wt(e),{writable:!0,value:[]}),Vt.set(Wt(e),{writable:!0,value:[]}),Xt.set(Wt(e),{writable:!0,value:[]}),e}return Gt(t,e),Nt(t,[{key:"config",value:function(){}},{key:"queue",value:function(){}},{key:"use",value:function(){}},{key:"getToken",value:function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{isRefresh:!1,withCredentials:!0};e.isRefresh,e.withCredentials}},{key:"getUserInfo",value:function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};e.rawData,e.signature,e.encryptedData,e.iv}},{key:"addEventListener",value:function(){}}]),t}(n),Ht=new WeakMap,Kt=new WeakMap,Vt=new WeakMap,Xt=new WeakMap,Yt="MINI_AUTH:token:",Zt="".concat(Yt,"beforeRefresh"),er="".concat(Yt,"afterRefresh"),tr="".concat(Yt,"beforeCache"),rr="".concat(Yt,"afterCache"),nr="".concat(Yt,"expired"),or="".concat(Yt,"beforeLogin"),ar="".concat(Yt,"afterLogin"),ir="".concat(Yt,"beforeRequest"),ur="".concat(Yt,"afterRequest"),cr="".concat(Yt,"wx:beforeLogin"),sr="".concat(Yt,"wx:successLogin"),fr="".concat(Yt,"wx:failLogin"),lr="".concat(Yt,"wx:beforeRequest"),pr="".concat(Yt,"wx:successRequest"),vr="".concat(Yt,"wx:failRequest"),hr="".concat(Yt,"ali:beforeLogin"),dr="".concat(Yt,"ali:successLogin"),yr="".concat(Yt,"ali:failLogin"),gr="".concat(Yt,"ali:beforeRequest"),br="".concat(Yt,"ali:successRequest"),wr="".concat(Yt,"ali:failRequest");function mr(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{},t=e.errCode||0;return{errCode:e.errCode||0,errMsg:0===t?"":e.errMsg||JSON.stringify(e),status:e.statusCode||e.status||-1,headers:e.header||null,data:e.data||null}}var _r=function(){function e(){Dt(this,e),$t(this,"context",{}),$t(this,"middleware",[])}return Nt(e,[{key:"createContext",value:function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{},t=Object.create(this.context);return Object.assign(t,e)}},{key:"dispatch",value:function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{},t=1<arguments.length?arguments[1]:void 0,r=this.createContext(e),n=this.runMiddleware(t||this.middleware);return n(r)}},{key:"runMiddleware",value:function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:[];return function(t,n){var o=-1;return new r((function(r,a){!function i(u,c){if(u<=o)return a(mr({errCode:5004,errMsg:"next() called multiple times"}));if(c)return a(c);var s=e[o=u];if(o===e.length&&(s=n),!s)return r(t);try{return s(t,i.bind(null,o+1))}catch(e){return a(mr({errCode:5005,errMsg:JSON.stringify(e)}))}}(0,null)}))}}},{key:"use",value:function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:function(){};if("function"!=typeof e)throw new Error("middle must be function!");this.middleware.push(e)}},{key:"useBatch",value:function(){var e=this,t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:[];t.forEach((function(t){e.use(t)}))}}]),e}();function Or(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};return t.checkPropTypes({timeout:t.number,scopes:t.array,force:t.bool},e)}var jr={timeout:2e4,scopes:["auth_base"],force:!0};function kr(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:"noName",r=2<arguments.length&&void 0!==arguments[2]?arguments[2]:{};e&&"function"==typeof e.emit&&e.emit(t,r)}function Sr(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{timeout:2e4},t=e.timeout,n=e.self;return new r((function(e,r){wx.login({timeout:t,success:function(t){e({errCode:0,errMsg:"",jsCode:t.code}),kr(n,sr,{res:t})},fail:function(e){r({errCode:5e3,errMsg:e.errMsg||JSON.stringify(e),jsCode:""}),kr(n,fr,{err:e})}}),kr(n,cr,{timeout:t})}))}function Pr(){return"undefined"!=typeof wx&&wx?wx:"undefined"!=typeof my&&my?my:"undefined"!=typeof swan&&swan?swan:"undefined"!=typeof tt&&tt?tt:global}var xr=Pr();function Tr(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{scopes:["auth_base"]},t=e.scopes,n=e.self;return new r((function(e,r){xr.getAuthCode({scopes:t,success:function(t){e({errCode:0,errMsg:"",jsCode:t.authCode}),kr(n,dr,{res:t})},fail:function(e){r({errCode:5009,errMsg:e.errMsg||JSON.stringify(e),jsCode:""}),kr(n,yr,{err:e})}}),kr(n,hr,{scopes:t})}))}function Er(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{env:"weapp"},t=e.timeout,r=e.env,n=e.scopes,o=e.force,a=e.self,i=null;switch(Or(Rt(jr,{timeout:t,scopes:n,force:o})),r){case"aliapp":i=Tr({scopes:n,self:a});break;case"swan":case"ttapp":case"weapp":default:i=Sr({timeout:t,self:a})}return i}function Cr(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};return t.checkPropTypes({url:t.string,data:t.object,headers:t.object,timeout:t.number,method:t.string},e)}var Rr={url:"",data:{},headers:{},timeout:3e4,method:"GET"};function Ar(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}function Mr(e){for(var t,r=1;r<arguments.length;r++)t=null==arguments[r]?{}:arguments[r],r%2?Ar(t,!0).forEach((function(r){$t(e,r,t[r])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):Ar(t).forEach((function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(t,r))}));return e}function qr(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{method:"GET",data:{}},t=e.url,n=e.data,o=e.headers,a=e.method,i=e.self;return new r((function(e,r){wx.request({url:t,data:n,header:o,method:a,success:function(t){e(mr(Mr({errCode:0},t))),kr(i,pr,{res:t})},fail:function(e){var t=5003;e.errMsg?t=-1<e.errMsg.toLowerCase().indexOf("timeout")?5001:5002:t=5003;r(mr(Mr({errCode:t},e))),kr(i,vr,{err:e})}}),kr(i,lr,{url:t,data:n,headers:o,method:a})}))}function Dr(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}function zr(e){for(var t,r=1;r<arguments.length;r++)t=null==arguments[r]?{}:arguments[r],r%2?Dr(t,!0).forEach((function(r){$t(e,r,t[r])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):Dr(t).forEach((function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(t,r))}));return e}var Nr=Pr();function Lr(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{method:"GET",data:{}},t=e.url,n=e.data,o=e.headers,a=e.method,i=e.timeout,u=e.self;return new r((function(e,r){Nr.request({url:t,data:n,headers:o,method:a,timeout:i,success:function(t){e(mr(zr({errCode:0},t))),kr(u,br,{res:t})},fail:function(e){var t=5006;e.errMsg?t=-1<e.errMsg.toLowerCase().indexOf("timeout")?5007:5008:t=5006;r(mr(zr({errCode:t},e))),kr(u,wr,{err:e})}}),kr(u,gr,{url:t,data:n,headers:o,method:a,timeout:i})}))}function Wr(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{env:"weapp"},t=e.url,r=e.timeout,n=e.data,o=e.headers,a=e.method,i=e.env,u=e.self,c=null;switch(Cr(Rt(Rr,{url:t,timeout:r,data:n,headers:o,method:a})),i){case"aliapp":c=Lr({self:u,url:t,data:n,headers:o,method:a});break;case"swan":case"ttapp":case"weapp":default:c=qr({self:u,url:t,data:n,headers:o,method:a})}return c}var Ir=Pr(),Fr={setStorageSync:Ir.setStorageSync.bind(Ir),getStorageSync:Ir.getStorageSync.bind(Ir),removeStorageSync:Ir.removeStorageSync.bind(Ir)},Ur=Pr(),Gr={setStorageSync:Ur.setStorageSync.bind(Ur),getStorageSync:Ur.getStorageSync.bind(Ur),removeStorageSync:Ur.removeStorageSync.bind(Ur)};function $r(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{env:"weapp"},t=e.env;return function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:"",r=1<arguments.length&&void 0!==arguments[1]?arguments[1]:"";try{switch(t){case"aliapp":Gr.setStorageSync({key:e,data:r});break;case"swan":case"ttapp":case"weapp":default:Fr.setStorageSync(e,r)}}catch(e){throw e}}}function Br(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{env:"weapp"},t=e.env;return function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:"",r=null;try{switch(t){case"aliapp":r=Gr.getStorageSync({key:e}).data;break;case"swan":case"ttapp":case"weapp":default:r=Fr.getStorageSync(e)}}catch(e){throw e}return r}}function Jr(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{env:"weapp"},t=e.env;return function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:"";try{switch(t){case"aliapp":Gr.removeStorageSync({key:e});break;case"swan":case"ttapp":case"weapp":default:Fr.removeStorageSync(e)}}catch(e){throw e}}}function Qr(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}function Hr(e){for(var t,r=1;r<arguments.length;r++)t=null==arguments[r]?{}:arguments[r],r%2?Qr(t,!0).forEach((function(r){$t(e,r,t[r])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):Qr(t).forEach((function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(t,r))}));return e}function Kr(e,t,r){if(!t.has(e))throw new TypeError("attempted to get private field on non-instance");return r}var Vr=function(e){function t(){var e,r=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};return Dt(this,t),e=It(this,Ft(t).call(this)),an.add(Wt(e)),on.add(Wt(e)),Xr.set(Wt(e),{writable:!0,value:{}}),Yr.set(Wt(e),{writable:!0,value:[]}),Zr.set(Wt(e),{writable:!0,value:[]}),en.set(Wt(e),{writable:!0,value:[]}),tn.set(Wt(e),{writable:!0,value:[]}),rn.set(Wt(e),{writable:!0,value:68e5}),nn.set(Wt(e),{writable:!0,value:!1}),$t(Wt(e),"tokenReqData",{}),$t(Wt(e),"tokenResData",{}),e.middleware=new _r,Jt(Wt(e),Xr,r),e}return Gt(t,e),Nt(t,[{key:"use",value:function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:"",t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:function(){};if("function"==typeof t)switch(e){case"afterToken":Bt(this,en).push(t);break;case"user":Bt(this,tn).push(t);break;case"token":default:Bt(this,Zr).push(t)}}},{key:"set2Storage",value:function(){function e(t){try{$r({env:Bt(this,Xr).env})(n.key,n.data)}catch(r){console.error(r),0<t&&e.call(this,t-1),this.emit(TOKEN_STORAGE_SET_ERR,{reqDta:n,err:r})}return n.data}var t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:"token",r=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{},n=Kr(this,an,cn).call(this,t,r);return e.call(this,3)}},{key:"getDataFromStorage",value:function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:"token",t=null;try{t=Br({env:Bt(this,Xr).env})(Kr(this,on,un).call(this,e))}catch(e){console.error(e),this.emit(TOKEN_STORAGE_GET_ERR,{reqDta:"token",err:e})}return t}},{key:"clearStorage",value:function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:"token";try{Jr({env:Bt(this,Xr).env})(Kr(this,on,un).call(this,e))}catch(e){console.error(e)}}},{key:"isExpired",value:function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};if(e){var t=e.expirationTime;return!(t&&t>Date.now())}return!0}},{key:"setTokenExpires",value:function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:0;(!e||isNaN(e))&&(e=68e5),Jt(this,rn,+e)}},{key:"runQueues",value:function(e,t){if(Bt(this,Yr)&&Array.isArray(Bt(this,Yr))){var r=Bt(this,Yr).length;Bt(this,Yr).splice(0,r).forEach((function(r){var n=r.resolve,o=r.reject;return e?o(e):n(t)}))}}},{key:"setTokenReqConfig",value:function(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:"";return null==e?null:void(Bt(this,Xr).tokenReqConfig[e]=t)}},{key:"getToken",value:function(){var e=this,t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{isRefresh:!1},n=t.isRefresh,o=t.scopes;return new r((function(t,r){if(Bt(e,nn))return Bt(e,Yr).push({resolve:t,reject:r});var a=Bt(e,Xr).env,i=Bt(e,Xr).tokenReqConfig,u=i.url,c=(i.headers,i.method),s=null;if(n)e.emit(Zt),e.clearStorage("token"),e.emit(er);else{if(s=e.getDataFromStorage("token"),e.emit(tr,s),s&&!e.isExpired(s))return t(s),void e.emit(rr,s);e.emit(nr,s),e.clearStorage("token")}e.emit(or),Jt(e,nn,!0),Er({self:e,env:a,scopes:o}).then((function(t){return e.tokenReqData.jsCode=t.jsCode,e.emit(ar,t),e.middleware.dispatch(e,Bt(e,Zr))})).then((function(t){return e.emit(ir),Wr({self:e,env:a,url:u,method:c,headers:i.headers||Bt(e,Xr).headers,data:Hr({},t.tokenReqData)})})).then((function(t){return e.tokenResData=t,e.middleware.dispatch(e,Bt(e,en))})).then((function(t){return e.emit(ur,t.tokenResData),e.set2Storage("token",t.tokenResData)})).then((function(r){t(r),e.runQueues(null,r),Jt(e,nn,!1),Jt(e,Yr,[])})).catch((function(t){r(t),e.runQueues(t),Jt(e,nn,!1),Jt(e,Yr,[])}))}))}},{key:"config",get:function(){return Bt(this,Xr)}},{key:"queue",get:function(){return this.waitQueues}}]),t}(Qt),Xr=new WeakMap,Yr=new WeakMap,Zr=new WeakMap,en=new WeakMap,tn=new WeakMap,rn=new WeakMap,nn=new WeakMap,on=new WeakSet,an=new WeakSet,un=function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:"token";return"MINI_AUTH:".concat(e,":").concat(Bt(this,Xr).appid)},cn=function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:"token",t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{};return{key:Kr(this,on,un).call(this,e),data:{data:t,expires:Bt(this,rn),expirationTime:Date.now()+Bt(this,rn)}}},sn={withCredentials:!1,env:"weapp",appid:"mockAppid",tokenReqConfig:{url:"",method:"GET",headers:{"content-type":"application/json"},timeout:1e4},userInfoReqConfig:{url:"",method:"GET",headers:{"content-type":"application/json"},timeout:1e4}};function fn(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{},t=Rt(sn,e);return qt(t),new Vr(t)}var ln=fn(sn);ln.create=fn,e.default=Vr,e.miniAuth=ln,Object.defineProperty(e,"__esModule",{value:!0})}));
//# sourceMappingURL=mini-auth.common.js.map
